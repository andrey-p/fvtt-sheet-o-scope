(function(n){typeof define=="function"&&define.amd?define(n):n()})(function(){"use strict";var ne=Object.defineProperty;var z=n=>{throw TypeError(n)};var ie=(n,s,a)=>s in n?ne(n,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[s]=a;var l=(n,s,a)=>ie(n,typeof s!="symbol"?s+"":s,a),M=(n,s,a)=>s.has(n)||z("Cannot "+a);var k=(n,s,a)=>(M(n,s,"read from private field"),a?a.call(n):s.get(n)),p=(n,s,a)=>s.has(n)?z("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(n):s.set(n,a),y=(n,s,a,S)=>(M(n,s,"write to private field"),S?S.call(n,a):s.set(n,a),a),c=(n,s,a)=>(M(n,s,"access private method"),a);var g,m,O,T,w,d,j,N,E,V,$,v,q,B,D,b,u,x,G,F,U,_;var n=(o=>(o.Main="main",o.PopUp="popUp",o))(n||{}),s=(o=>(o.Actor="actor",o.Item="item",o.Journal="journal",o))(s||{});function a(o){return new URL(o).searchParams.get("sheetView")?n.PopUp:n.Main}function S(o){const e=new URL(o).searchParams;if(e.get("sheetView")){const t=e.get("id"),r=e.get("type");if(t&&r&&Object.values(s).includes(r))return{id:t,type:r}}return null}function P(){return game}function W(o,i){var t,r,h,f,H,L;const e=P();if(i===s.Actor)return(r=(t=e.actors)==null?void 0:t.get(o))==null?void 0:r.sheet;if(i===s.Item)return(f=(h=e.items)==null?void 0:h.get(o))==null?void 0:f.sheet;if(i===s.Journal)return(L=(H=e.journal)==null?void 0:H.get(o))==null?void 0:L.sheet}var C=(o=>(o.Reattach="reattach",o))(C||{});class A extends EventTarget{constructor(e=null){super();p(this,m);p(this,g);y(this,g,e),window.addEventListener("message",c(this,m,O).bind(this))}send(e,t){const r={sender:"sheet-o-scope",action:e,data:t};k(this,g)&&k(this,g).postMessage(r)}}g=new WeakMap,m=new WeakSet,O=function(e){if(c(this,m,T).call(this,e)){const t=new MessageEvent("message",{data:e.data});this.dispatchEvent(t)}},T=function(e){const t=e.data;return e.origin===window.location.origin&&t.sender==="sheet-o-scope"};class K{constructor(){l(this,"label","SHEET-O-SCOPE.detach");l(this,"class","sheet-detach");l(this,"icon","fa-solid fa-arrow-right-from-bracket");l(this,"onclick",null)}}class Q extends EventTarget{constructor(){super();p(this,d);p(this,w);y(this,w,new A),Hooks.once("ready",c(this,d,j).bind(this))}}w=new WeakMap,d=new WeakSet,j=function(){var t,r,h;const e=P();if(!((t=e.modules.get("lib-wrapper"))!=null&&t.active)&&((r=e.user)!=null&&r.isGM)){(h=ui.notifications)==null||h.error('Module sheet-o-scope requires the "libWrapper" module. Please install and activate it.');return}Hooks.on("getActorSheetHeaderButtons",c(this,d,E).bind(this,s.Actor)),Hooks.on("getItemSheetHeaderButtons",c(this,d,E).bind(this,s.Item)),Hooks.on("getJournalSheetHeaderButtons",c(this,d,E).bind(this,s.Journal)),k(this,w).addEventListener("message",c(this,d,N).bind(this))},N=function(e){const t=e.data;t.action===C.Reattach&&c(this,d,$).call(this,t.data)},E=function(e,t,r){const h=new K;h.onclick=()=>{c(this,d,V).call(this,e,t)},r.unshift(h)},V=function(e,t){const{width:r,height:h}=t.options,f=t.document.id;t.close(),window.open(`/game?sheetView=1&id=${f}&type=${e}`,"_blank",`popup=true,width=${r},height=${h}`)},$=function(e){const{id:t,type:r}=e,h=W(t,r);h&&h.render(!0)};class X{constructor(){l(this,"label","SHEET-O-SCOPE.reattach");l(this,"class","sheet-reattach");l(this,"icon","fa-solid fa-arrow-right-to-bracket");l(this,"onclick",null)}}class Y{constructor(){p(this,v)}run(){const i=c(this,v,q);libWrapper.register("sheet-o-scope","Notifications.prototype.notify",function(e,...t){return i(t)?-1:e(...t)})}}v=new WeakSet,q=function(i){const[e,t]=i;return!!(t==="info"&&e.includes("not displayed because the game Canvas is disabled")||t==="error"&&e.includes("Foundry Virtual Tabletop requires a minimum screen resolution"))};class Z{constructor(){p(this,B)}run(){const i=c(this,B,D);libWrapper.register("sheet-o-scope","Application.prototype.render",function(e,...t){return i(this)?this:e(...t)})}}B=new WeakSet,D=function(i){return!!["navigation","sidebar","players","hotbar","pause","controls"].includes(i.options.id)};class ee{run(){libWrapper.register("sheet-o-scope","ClientSettings.prototype.get",function(i,...e){return e.join(".")==="core.noCanvas"?!0:i(...e)})}}const te=[Y,Z,ee];class se{constructor(i){p(this,u);p(this,b);var e;y(this,b,new A(window.opener)),Hooks.once("init",c(this,u,x).bind(this)),Hooks.once("ready",c(this,u,G).bind(this,i)),Hooks.on("getActorSheetHeaderButtons",c(this,u,U).bind(this,s.Actor)),Hooks.on("getItemSheetHeaderButtons",c(this,u,U).bind(this,s.Item)),Hooks.on("getJournalSheetHeaderButtons",c(this,u,U).bind(this,s.Journal)),(e=document.querySelector("body"))==null||e.classList.add("sheet-o-scope-popup")}}b=new WeakMap,u=new WeakSet,x=function(){te.forEach(i=>{new i().run()})},G=function(i){const{id:e,type:t}=i,r=W(e,t);r&&r.render(!0,{minimizable:!1,resizable:!1}),window.addEventListener("resize",c(this,u,F).bind(this,r))},F=function(i){i&&i.setPosition({width:window.innerWidth,height:window.innerHeight})},U=function(i,e,t){const r=e.document.id;if(!r)return;const h=t.find(H=>H.class==="close");h&&(h.onclick=()=>{window.close()});const f=new X;f.onclick=()=>{c(this,u,_).call(this,i,r)},t.unshift(f)},_=function(i,e){k(this,b).send(C.Reattach,{id:e,type:i}),window.close()};const R=window.location.toString(),I=a(R),J=S(R);I===n.Main?new Q:I===n.PopUp&&J&&new se(J)});
